# Biomass {#cha:biomass}


```{r biomass-setup, message=FALSE, warning=FALSE, echo=FALSE}
source('_setup.R')
```

The wheat is mainly source limited in APSIM-Wheat model. 

The biomass and nitrogen of each organ is separated into two pools (i.e. `Live` and `Dead`). Each pool is separated into three components (i.e. `Structural`, `Metabolic`, `Storage`) [@BrownPlantModellingFramework2014].


* **Structural biomass and N** are essential for the growth of the organ. They remain within the organ once it has been allocated and are passed from Live to Dead pools as the organ senescence.
* **Metabolic biomass and N** are essential for growth and their concentration can influence the function of organs (e.g. photosynthetic efficiency of the leaf depends on Metabolic nitrogen content). Metabolic biomass and nitrogen may be reallocated (moved to another organ upon senescence of this organ) or retranslocated
(moved to another organ at any time when supplies do not meet the structural and metabolic biomass demands of growing organs).
* **Storage biomass and N** are non-essential to the function of an organ. They will be allocated to an organ only when all other organs have received their Structural and Metabolic allocations and may be reallocated or retranslocated.



## Supply {#sec:biomass-supply}

Biomass supplies are divided into three sources, i.e fixation (i.e. photosynthesis), retanslocation, reallocation (Table \@ref(tab:biomass-supply-type)). The only source of fixation is organ `Leaf`. The sources of retanslocation include organs `Spike` and `Stem`. No reallocation is considered in the wheat model. See details in the organs about the dynamic of biomass supply. 


```{r biomass-supply-type, results='asis'}

g_report %>% 
    select(matches('Wheat\\..+\\.DMSupply\\..+')) %>% 
    assertr::verify(ncol(.) == 15) %>% 
    summarise_all(funs(sum(. > 0))) %>% 
    gather(trait, value) %>% 
    mutate(value = ifelse(value > 0, 'X', '-')) %>% 
    separate(trait, into = c('Crop', 'Organ', 'DMSupply', 'Pool')) %>% 
    select(Organ, Pool, value) %>%
    mutate(Pool = factor(Pool, levels = c('Fixation', 'Retranslocation', 'Reallocation')),
           Organ = factor(Organ, levels = g_organs)) %>% 
    spread(Pool, value) %>% 
    knitr::kable(align = "c",
                 caption = 'The source of biomass supply in all organs. X and - indicate the organ has and has not the source, respectively.')
```




<div class="fig-output">
```{r biomass-supply-total, fig.asp = 1, fig.cap='Biomass total supply from all organs'}
y_cols <- c('Wheat.DMSupply')
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Fixation (g/d)')

```
</div>




<div class="fig-output">
```{r biomass-supply-fixation, fig.asp = 1, fig.cap='Biomass fixation from all organs'}
y_cols <- sprintf('Wheat.%s.DMSupply.Fixation', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Fixation (g/d)', y_labels = g_organs,
            ncol = 5)
```
</div>


<div class="fig-output">
```{r biomass-supply-retranslocation, fig.asp = 1, fig.cap='Biomass retranslocation from all organs'}
y_cols <- sprintf('Wheat.%s.DMSupply.Retranslocation', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Retranslocation', y_labels = g_organs,
            ncol = 5)

```
</div>




<div class="fig-output">
```{r biomass-supply-reallocation, fig.asp = 1, fig.cap='Biomass reallocation from all organs'}
y_cols <- sprintf('Wheat.%s.DMSupply.Reallocation', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Reallocation', y_labels = g_organs,
            ncol = 5)
```
</div>


## Demand {#sec:biomass-demand}

Depending on the organ, not all components are considered (Table \@ref(tab:biomass-component-type)). `Structural` component is considered in all organs. `Metabolic` component is only considered in `Leaf` (Chapter \@ref(cha:leaf)). `Storage` component is only considered in `Stem` (Chapter \@ref(cha:stem)) and `Spike` (Chapter \@ref(cha:spike)).

```{r biomass-component-type, results='asis'}
g_report %>% 
    select(matches('Wheat\\..+\\.DMDemand\\..+')) %>% 
    assertr::verify(ncol(.) == 15) %>% 
    summarise_all(funs(sum(. > 0))) %>% 
    gather(trait, value) %>% 
    mutate(value = ifelse(value > 0, 'X', '-')) %>% 
    separate(trait, into = c('Crop', 'Organ', 'DMDemand', 'Pool')) %>% 
    select(Organ, Pool, value) %>%
    mutate(Pool = factor(Pool, levels = c('Structural', 'Metabolic', 'Storage')),
           Organ = factor(Organ, levels = g_organs)) %>% 
    spread(Pool, value) %>% 
    knitr::kable(align = "c",
                 caption = 'The three components of biomass in all organs. X and - indicate the organ has and has not the component, respectively.')
```


`Stem` and `Root` demands determine as the fraction of daily `Fixation` (Fig. \@ref(fig:stem-demand-fraction), and \@ref(fig:root-demand-fraction)). The `Spike` demand determines as the head number and growth duration (Fig. \@ref(fig:spike-demand)).



<div class="fig-output">
```{r biomass-demand-organ, fig.asp = 1, fig.cap='Total biomass demand for structural and metabolic from each organ'}
y_cols <- sprintf('Wheat.DMDemand.SM.%s', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Structural and metabolic demand (g/m2)', y_labels = g_organs,
            ncol = 5)
```
</div>




<div class="fig-output">
```{r biomass-demand-structural, fig.asp = 1, fig.cap='Biomass structural demand from all organs'}
y_cols <- sprintf('Wheat.%s.DMDemand.Structural', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Structural demand (g/g)', y_labels = g_organs,
            ncol = 5)

```
</div>



<div class="fig-output">
```{r biomass-demand-metabolic, fig.asp = 1, fig.cap='Biomass metabolic demand from all organs'}
y_cols <- sprintf('Wheat.%s.DMDemand.Metabolic', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Metabolic demand (g/d)', 
            y_labels = g_organs,
            ncol = 5)

```
</div>

<div class="fig-output">
```{r biomass-demand-storage, fig.asp = 1, fig.cap='Biomass storage demand from all organs'}
y_cols <- sprintf('Wheat.%s.DMDemand.Storage', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Storage demand (g/d)', y_labels = g_organs,
            ncol = 5)

```
</div>

## Respiration {#sec-respiration}

As the major roles of carbon balance of crop, respiration is separated into two components, i.e. growth and maintenance respiration [@vanIerselGrowthRespirationMaintenance2000; @ChiarielloGrowthcarbonallocation2000]. @vanIerselGrowthRespirationMaintenance2000 described "growth respiration is referred as the amount of carbohydrates respired in a net gain in plant biomass. This includes the production of ATP and reductant for biosynthetic processes, transport processes, and nutrient uptake and reduction. Maintenance respiration is defined as the respiration needed to provide the energy for all plant processes that do not result in a net increase in plant dry matter, such as maintenance of ion gradients across membranes and the resynthesis of degraded organic compounds".

### Growth respiration (Conversion efficiency))
The allocated biomass of an organ losses through growth respiration (i.e, 1 - Conversion efficiency). The growth respiration is applied to all components of an organ (i.e. structural, metabolic, storage).

```{r biomass-conversion-efficiency, results='asis'}
path <- sprintf("Wheat.%s.DMConversionEfficiency", g_organs)
g_organs_df %>% 
    mutate(`Conversion efficiency` = get_fixed_value(g_pmf, path)) %>% 
    kable(caption = "Biomass conversion efficiency for all organs.")
register_chunk(path, paste0('tab:', opts_current$get("label")),
                   type = 'input')

```



<div class="fig-output">
```{r biomass-growth-respiration, fig.asp = 1, fig.cap='Growth respiration for all organs'}
y_cols <- sprintf('Wheat.%s.GrowthRespiration', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Storage demand (g/d)', y_labels = g_organs,
            ncol = 5)

```
</div>

### Maintenance respiration

The maintenance respiration is required for metabolic and storage components (Table \@ref(tab:biomass-component-type)). The metabolic and storage components of `Live` pool is daily reduced according to a fraction which is used for maintenance respiration (Fig. \@ref(fig:biomass-maintenance-respiration-fraction)). The maintenance fraction is calculated as reference maintenance fraction at 20 C and a beta function [@WangSimulationphenologicaldevelopment1998] with three cardinal temperatures (i.e. minimum, optimal and maximum temperatures). All organs have the same cardinal temperatures, but different maintenance fraction at 20C (Table \@ref(tab:biomass-wefuncton)). Finally, the actual maintenance fraction depends on the daily mean temperature (Fig. \@ref(fig:biomass-maintenance-respiration-fraction). `Leaf` and `Stem` have the major contributions to maintenance respiration (Fig. \@ref(fig:biomass-maintenance-respiration)). Root and Grain don't have maintenance respiration (Fig. \@ref(fig:biomass-maintenance-respiration)).

```{r biomass-wefuncton, results='asis'}
path <- sprintf('Wheat.%s.MaintenanceRespirationFunction.MaintenanceFractionAt20C', 
                g_organs)
register_chunk(path, paste0('tab:', opts_current$get("label")),
                   type = 'input')
ref20 <- get_fixed_value(g_pmf, path)
path <- sprintf('Wheat.%s.MaintenanceRespirationFunction.WangEngelTempFunction', 
                g_organs)
register_chunk(path, paste0('tab:', opts_current$get("label")),
                   type = 'input')
respiration <- get_xml_children(g_pmf, path, g_organs) %>% 
    mutate(MinTemp = as.numeric(MinTemp),
           OptTemp = as.numeric(OptTemp),
           MaxTemp = as.numeric(MaxTemp),
           RefTemp = as.numeric(RefTemp),
           MaximumTemperatureWeighting = as.numeric(MaximumTemperatureWeighting)) %>% 
    mutate(MaintenanceFractionAt20C = ref20) 
respiration %>% 
    select(Organ = trait, `$T_{min}$` = MinTemp, `$T_{opt}$` = OptTemp, 
           `$T_{max}$` = MaxTemp, `$T_{ref}$` = RefTemp,
           `$W$` = MaximumTemperatureWeighting,
           `$M_{20}$` = MaintenanceFractionAt20C) %>% 
    kable(caption = "The parameter values of maintenance fractions for all organs. $T_{min}$, $T_{opt}$ and $T_{max}$ are the minimum, optimum and maximum temperatures in the Wang and Engle's beta equation. The $W$ is the weighting of maximum temperature when calculats daily mean temperature. The $T_{ref}$ and $M_{20}$ are the reference temperature and fraction of maintenance fractions at reference temperature.")

```


<div class="fig-input">
```{r biomass-maintenance-respiration-beta, fig.asp = 0.5, fig.cap='The response of maintenance respiration on daily average temperature with a beta function [@WangSimulationphenologicaldevelopment1998], which is reproduced from parameter values in Table \\@ref(tab:biomass-wefuncton).'}
avgt <- seq(0, 40)
res_fun <- function(df) {
    v <- we_beta(avgt - 1, avgt + 1, df$MinTemp, df$OptTemp, 
            df$MaxTemp, df$RefTemp, 
            df$MaximumTemperatureWeighting) *
        df$MaintenanceFractionAt20C
    data_frame(avgt = avgt, MaintenanceFraction = v, 
               Organ = df$trait)
}
respiration %>% 
    rowwise() %>% 
    do(res_fun(.)) %>% 
    ggplot() +
    geom_line(aes(avgt, MaintenanceFraction, color = Organ)) +
    xlab('Daily mean temperature (C)') +
    ylab('Fraction of maintenance') +
    theme_bw() +
    guides(color = guide_legend(title = NULL)) +
    theme(legend.position = 'bottom')


```
</div>



<div class="fig-input">
```{r biomass-maintenance-respiration-fraction, fig.asp = 1, fig.cap='Daily fraction of maintenance respiration for all organs. The maintenance respirations of two groups of organs overlap each other (i.e. stem and root, spike and grain).'}
y_cols <- sprintf('Wheat.%s.MaintenanceRespirationFunction', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Maintenance respiration', y_labels = g_organs,
            ncol = 5)

```
</div>



<div class="fig-output">
```{r biomass-maintenance-respiration, fig.asp = 1, fig.cap='Daily maintenance respiration for all organs.'}
y_cols <- sprintf('Wheat.%s.MaintenanceRespiration', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Daily maintenance respiration', y_labels = g_organs,
            ncol = 5)
```
</div>



## Biomass partitioning

The biomass partitions into structural and metabolic components firstly according to the relative demands. The remaining biomass allocates into storage according to the relative demands. The greatest storage demand of stem can store all remaining daily supply. 


The daily supply is distributed into `Structural` and `Metabolic` components, then `Storage` component. The daily demand cannot be satisfied if the structural and metabolic demands are more than daily supply, then the allocated biomasses of all organs are proportionally reduced to match daily supply (Fig. \@ref(fig:biomass-supply-demand-str-met)). The extra daily supply is distributed into storage, i.e. `Stem` for wheat model, as the extreme higher storage demand for stem (Fig. \@ref(fig:biomass-supply-demand-sto)).

<div class="fig-output">
```{r biomass-supply-demand-str-met, fig.asp = 1, fig.cap='Daily biomass supply, and structural and metabolic demands for all organs.'}
y_cols <- c('Wheat.DMSupply', 'Wheat.DMDemand.StructuralMetabolic')
y_labels <- c('Supply', 'Demand')
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Biomass supply and demand', y_labels = y_labels,
            ncol = 5)

```
</div>

<div class="fig-output">
```{r biomass-supply-demand-sto, fig.asp = 1, fig.cap='Daily biomass supply and storage demand for all organs'}
y_cols <- c('Wheat.DMSupply', 'Wheat.DMDemand.Storage')
y_labels <- c('Supply', 'Demand')
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Biomass supply and demand', y_labels = y_labels,
            ncol = 5)

```
</div>


The actual allocated biomass for each organ depends on the daily supply, relative structural and metabolic demand, and storage demands among all organs (Fig. \@ref(fig:biomass-allocated-structural), \@ref(fig:biomass-allocated-metabolic) and \@ref(fig:biomass-allocated-storage)). 

<div class="fig-output">
```{r biomass-allocated-structural, fig.asp = 1, fig.cap='Biomass structural allocation from all organs'}
y_cols <- sprintf('Wheat.%s.Allocated.StructuralWt', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Structural allocation', 
            y_labels = g_organs,
            ncol = 5)

```
</div>


<div class="fig-output">
```{r biomass-allocated-metabolic, fig.asp = 1, fig.cap='Biomass metabolic allocation from all organs'}
y_cols <- sprintf('Wheat.%s.Allocated.MetabolicWt', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Metabolic allocation', y_labels = g_organs,
            ncol = 5)

```
</div>


<div class="fig-output">
```{r biomass-allocated-storage, fig.asp = 1, fig.cap='Biomass storage allocation from all organs'}
y_cols <- sprintf('Wheat.%s.Allocated.StorageWt', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Storage allocation', y_labels = g_organs,
            ncol = 5)

```
</div>


The daily biomass supply (Fig. \@ref(fig:biomass-supply-total)) are consumed as growth respiration before partitioning into `Live` pool in each organ, and consumed as daily maintenance respiration from `Live` pool in each organ (Fig. \@ref(fig:biomass-denstiny)).

<div class="fig-output">
```{r biomass-denstiny, fig.asp = 1, fig.cap='Daily biomass supply and respiration.'}
y_cols <- sprintf('Wheat.%s.GrowthRespiration', g_organs)

growth_respiration <- g_report %>% 
    select(y_cols) %>% 
    rowSums() %>% 
    as.numeric()

y_cols <- sprintf('Wheat.%s.MaintenanceRespiration', g_organs)
maintenance_respiration <- g_report %>% 
    select(y_cols) %>% 
    rowSums() %>% 
    as.numeric()

g_report %<>%  
    mutate(Wheat.GrowthRespiration = growth_respiration,
           Wheat.MaintenanceRespiration = maintenance_respiration)

y_cols <- c('Wheat.DMSupply', 'Wheat.GrowthRespiration', 'Wheat.MaintenanceRespiration')
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Fixation (g/d)', ncol = 3)

```
</div>



## Biomass pool {#sec:biomass-pool}

All organs have the `Live` pool, but only `Leaf` has the `Dead` pool (Table \@ref(tab:biomass-live-dead-tbl)). 

```{r biomass-live-dead-tbl, results='asis'}
g_report %>% 
    select(matches('Wheat\\..+\\.(Live|Dead)\\..+')) %>% 
    assertr::verify(ncol(.) == 30) %>% 
    summarise_all(funs(sum(. > 0))) %>% 
    gather(trait, value) %>% 
    separate(trait, into = c('Crop', 'Organ', 'Biomass', 'Pool')) %>% 
    group_by(Organ, Biomass) %>% 
    summarise(value = sum(value)) %>% 
    ungroup() %>% 
    mutate(value = ifelse(value > 0, 'X', '-')) %>% 
    mutate(Biomass = factor(Biomass, levels = c('Live', 'Dead')),
           Organ = factor(Organ, levels = c('Grain', "Root", "Leaf", "Spike", "Stem"))) %>% 
    spread(Biomass, value) %>% 
    knitr::kable(align = "c",
                 caption = 'The live and dead groups of biomass in all organs. X and - indicate the organ has and has not the group, respectively.')
```




<div class="fig-output">
```{r biomass-live-dead, fig.asp = 1, fig.cap='Dry weight of Live and Dead pools'}
y_cols <- c('Wheat.TotalDeadWt', 'Wheat.TotalLiveWt')
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Dry weight (g/m2)', y_labels = c("Dead", "Live"),
            ncol = 5)

```
</div>




<div class="fig-output">
```{r biomass-live-weight, fig.asp = 1, fig.cap='Dry weight of Live pool for all organs'}
y_cols <- sprintf('Wheat.%s.LiveWt', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Dry weight (g/m2)', y_labels = g_organs,
            ncol = 5)

```
</div>


<div class="fig-output">
```{r biomass-dead-weight, fig.asp = 1, fig.cap='Dry weight of Dead pool for all organs'}
y_cols <- sprintf('Wheat.%s.DeadWt', g_organs)
plot_report(g_report, g_xvar, y_cols, x_lab = g_xlab, 
            y_lab = 'Dry weight (g/m2)', y_labels = g_organs,
            ncol = 5)

```
</div>



