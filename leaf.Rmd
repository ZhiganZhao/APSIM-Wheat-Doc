# Leaf {#cha:leaf}


```{r leaf-setup, message=FALSE, warning=FALSE, echo=FALSE}
source('_setup.R')
```


The apex model is developed to simulate leaf dynamic based on leaf cohort model.



## Life growth cycle {#sec:leaf-growth-cycle}

The growth cycle of leaf cohort is divided into 7 stages and 6 periods from `Initialized` to `Detached`. The length of each period depends on the `phylochron` during `Appearance` from `Initialized` to `Appeared` (fixed by `r node_count(pmf, '//LeafCohort')` initial leaves at `Germination`). Other periods are configured by `CohortParameters` at `Appearance`, so that parameter values are determined by the values of status variables at the day of leaf cohort `Appearance` if they depend on other variables.

Several status variables are defined for each leaf cohort, which can be used in other modules to describe the current status of leaf cohort, i.e. `IsNotAppeared`, `IsGrowing`, `IsAlive`, `IsGreen`, `IsNotSenescing`, `Senescing`, `isFullyExpanded`, `ShouldBeDead`, `IsAppeared` and `IsInitialised`. 

<div class="fig-input">
```{r leaf-life-cycle, out.width='95%', fig.asp=0.7, fig.cap='The life cycle of a leaf cohort.'}

DiagrammeR("sequenceDiagram;
	Initialized->>Appeared: Appearance 
	Appeared->>Expanded: GrowthDuration
	Expanded->>Senescing: LagDuration
	Senescing->>Senesced: SenescenceDuration
	Senesced->>Detaching: DetachmentLagDuration
	Detaching->>Detached: DetachmentDuration
    Initialized->Appeared: IsNotAppeared
    Initialized->Expanded: IsGrowing
	Initialized->>Senesced: IsAlive
	Initialized->>Senesced: IsGreen
	Initialized->>Senescing: IsNotSenescing
	Senescing->>Senesced: IsSenescing
	Expanded->>Detached: IsFullyExpanded
	Senesced->>Detached: ShouldBeDead
	Senesced->>Detached: Finished
	Appeared->>Detached: IsAppeared
	Initialized->>Detached: IsInitialised
")
```
</div>



### leaf age

The age of leaf cohort is defined as the thermal time after appearance, (i.e. keep zero after initialization). As the default values of `DetachmentLagDuration` and `DetachmentDuration` are set as `1000000` <sup>&deg;</sup>Cd, the cohort age keeps increasing until growth stage `ReadyForHarvesting`. The age of first leaf cohort starts from  200 <sup>&deg;</sup>Cd.


### Leaf initialization and appearance

At `Germination`, `r node_count(pmf, '//LeafCohort')` new leaf cohorts are initialized with initial leaf area `r paste(get_xml_value(pmf, '//LeafCohort//Area'), collapse = ', ')` mm^2^. The inital leaf area simulates seed biomass or embryo size. 

At `Emergence` stage, `r sum(get_xml_value(pmf, '//LeafCohort//Area') > 0)` leaf cohort is appeared at the main stem, and `r sum(get_xml_value(pmf, '//LeafCohort//Area') > 0)` new leaf cohort is initialized. 

After `Emergence` and before plant reaches the final leaf number (i.e. all leaves are initialized and appeared), a new leaf cohort initialises and an existing leaf cohot appears when increases of potential appearance of tip number are more than 1 (Figure \@ref(fig:str-delta-tip)). Consequently, the rates of leaf initialization and appearance are same, except initialized tip number is more than `r node_count(pmf, '//LeafCohort')`  of appeared tip number (Fig. \@ref(fig:leaf-cohort-number)).

<div class="fig-output">
```{r leaf-cohort-number, fig.cap='The initialized and appeared leaf cohort number in the main stem'}
y_cols <- c('Wheat.Leaf.AppearedCohortNo',
            'Wheat.Leaf.InitialisedCohortNo')
y_labels <- c('Appeared', 'Initialised')
plot_report(report, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Number', ncol = 2, y_labels = y_labels)

```
</div>


### Leaf growth and senescing

**Growth (expansion) duration**

Leaf expansion of cohort $i$ starts from appearance of leaf tip $i$, i.e. the expansion of leaf cohort in the sheath is ignored which does not contribute to green leaf or leaf area index. The growth duration of spring wheat is close to one phylochron as the synchronization of leaf blade and sheath [@SkinnerElongationGrassLeaf1995]. The growth duration is set as 1.3 phyllochron in default.

**Lag duration**

Lag duration (full functional duration) is defined as 4 phyllochrons for leaf appeared during vegetative period (from `Emergence` to `TerminalSpikelet`) and adjusted by leaf age. For leaf cohort appeared during stem elongation period (from `TerminalSpikelet` to `FlagLeaf`), the lag duration equals to total length from stage `FlagLeaf` to stage `EndGrainFill` minus 3 phyllochron (`senescence duration`), i.e. flag leaf is completely death at the stage `EndGrainFill`. 


**Senescene duration**

Senescence duration is defined as 3 phyllochrons in default.

As the variation of phyllochron (Fig. \@ref(fig:str-phyllochron)), the growth, lag and senescence durations also change by cohort rank (Fig. \@ref(fig:leaf-duration)). The growth duration of flag leaf is shorter than secondary leaf as the fraction of flag leaf.

<div class="fig-input">
```{r leaf-duration, fig.asp=0.5, fig.cap='Senescene duration of leaf cohort which is determined at appearance of leaf cohort. The black dots indicate the appearances of leaf cohorts'}
y_cols <- c('Wheat.Leaf.CohortParameters.GrowthDuration',
            'Wheat.Leaf.CohortParameters.LagDuration',
    'Wheat.Leaf.CohortParameters.SenescenceDuration')
y_labels <- c('Growth', 'Lag', 'Senescence')
plot_report(
    report, x_var2, y_cols, x_lab = x_lab,
    y_lab = 'Duration of leaf cohort (oCd)',
    ncol = 3, y_labels = y_labels, cohort = TRUE)
```
</div>


Figures \@ref(fig:leaf-cohort-changing-no) and \@ref(fig:leaf-cohort-status-no) shows the number of leaf cohorts changing status including expanding and senescing and at certain status including expanded, green, and dead, respectively.

<div class="fig-output">
```{r leaf-cohort-changing-no, fig.asp = 1, fig.cap="The number of leaf cohort with certain status including expanding and senescing"}
y_cols <- c("Wheat.Leaf.ExpandingCohortNo",
            "Wheat.Leaf.SenescingCohortNo")
y_labels <- gsub('Wheat\\.Leaf\\.(.+)CohortNo', "\\1", y_cols)
plot_report(report, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Fixation (g/d)',  y_labels = y_labels,
            ncol = 2)

```
</div>


<div class="fig-output">
```{r leaf-cohort-status-no, fig.asp = 1, fig.cap="The number of leaf cohort with certain status including expanded, green, dead"}
y_cols <- c("Wheat.Leaf.ExpandedCohortNo",
            "Wheat.Leaf.GreenCohortNo",
            "Wheat.Leaf.DeadCohortNo")
y_labels <- gsub('Wheat\\.Leaf\\.(.+)CohortNo', "\\1", y_cols)
plot_report(report, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Fixation (g/d)',  y_labels = y_labels,
            ncol = 3)

```
</div>




### Detachment lag and detachment durations
Detachment lag and detachment durations for leaf cohort are set as a big value `1000000` which assumes no detachment in wheat leaf. Actually all leaves are detached at `Harvesting` event. 


## Supply {#sec:leaf-supply}

In `Leaf` organ, the biomass supply only sources from `Fixation` (i.e. photosynthesis, Fig. \@ref(fig:leaf-supply)). Three photosynthesis models are implemented in the APSIM next generation.

### RUE model


### Enli's photosynthesis model

### Layered Canopy Photosynthesis Model with Transpiration (or DCaPS)


<div class="fig-output">
```{r leaf-supply, fig.asp = 1, fig.cap='Biomass supply from leaf'}
y_cols <- c('Wheat.Leaf.DMSupply.Fixation',
            'Wheat.Leaf.DMSupply.Retranslocation',
            'Wheat.Leaf.DMSupply.Reallocation')

plot_report(report, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Demand (g/d)', ncol = 3)

```
</div>




## Demand {#sec:leaf-deman}

<div class="fig-output">
```{r leaf-demand, fig.asp = 1, fig.cap='Biomass demand by leaf'}
y_cols <- c('Wheat.Leaf.DMDemand.Structural',
'Wheat.Leaf.DMDemand.Storage',
'Wheat.Leaf.DMDemand.Metabolic')
plot_report(report, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Demand (g/d)', ncol = 3)

```
</div>

## Biomass dynamic {#sec:leaf-biomass}

<div class="fig-output">
```{r leaf-allocated, fig.asp = 1, fig.cap='Actual allocated biomass for leaf'}
y_cols <- c('Wheat.Leaf.Allocated.StructuralWt',
'Wheat.Leaf.Allocated.StorageWt',
'Wheat.Leaf.Allocated.MetabolicWt')

plot_report(report, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Biomass (g/m2)', ncol = 3)

```
</div>




<div class="fig-output">
```{r leaf-weight, fig.asp = 1, fig.cap='Dynamic of leaf biomass (Total)'}
y_cols <- c('Wheat.LeafWt',
             'Wheat.Leaf.LiveWeight', 
             'Wheat.Leaf.DeadWeight')
y_labels <- c('Total', 'Live', 'Dead')
plot_report(report, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Biomass (g/m2)', ncol = 3, y_labels = y_labels)

```
</div>



<div class="fig-output">
```{r leaf-live, fig.asp = 1, fig.cap='Dynamic of leaf biomass (Live component)'}
y_cols <- c('Wheat.Leaf.Live.StructuralWt',
'Wheat.Leaf.Live.StorageWt',
'Wheat.Leaf.Live.MetabolicWt')
plot_report(report, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Biomass (g/m2)', ncol = 3)

```
</div>


<div class="fig-output">
```{r leaf-dead, fig.asp = 1, fig.cap='Dynamic of leaf biomass (Dead component)'}
y_cols <- c('Wheat.Leaf.Dead.StructuralWt',
'Wheat.Leaf.Dead.StorageWt',
'Wheat.Leaf.Dead.MetabolicWt')
plot_report(report, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Biomass (g/m2)', ncol = 3)
```
</div>




<!-- 

### Drought stress on leaf development

After appearance, leaf development is accelerated by the drought stress through increasing the daily thermal time, i.e. leaf age is accelerated by drought. The factor of acceleration depends on the ratio of water supply and demand (Figure \@ref(fig:water-supply-demand-ratio)). Daily thermal time is doubled when there is no water supply (i.e. Ratio of water supply and demand equals to zero), and no acceleration when ratio above 0.7 (The values in Figure \@ref(fig:leaf-development-drought) plus one).


<div class="fig-input">
```{r leaf-development-drought, fig.asp = 0.75, fig.cap='Drought stress accelerates leaf development. Daily thermal time is doubled when there is no water supply (i.e. Ratio of water supply and demand equals to zero), and no acceleration when ratio above 0.7.'}


xpath <- '//AddFunction[Name="DroughtInducedSenAcceleration"]/MultiplyFunction[Name="Stress"]/LinearInterpolationFunction[Name="StressFactor"]'
plot_xypair(pmf, xpath, x_lab = 'Ratio of water supply and demand', y_lab = 'Ratio of acceleration of thermal time')
```
</div>


```csharp
//Acellerate thermal time accumulation if crop is water stressed.
double _ThermalTime;
if ((LeafCohortParameters.DroughtInducedSenAcceleration != null) && (IsFullyExpanded))
    _ThermalTime = TT * LeafCohortParameters.DroughtInducedSenAcceleration.Value;
else _ThermalTime = TT;

```


## Cohort population

Cohort population is initialized as the total stem population at appearance of leaf cohort, and proportionally reduced by plant and stem mortalities (\@ref(#sec-structure-mortality)) at each day after appearance.

<div class='fig-output'>
```{r live-population}
# y_cols <- c('Wheat.Leaf.CohortLivePopulation')
# plot_report_vector(report, x_var, y_cols, x_lab = x_lab, y_lab = 'Live (cohort) population')

```
</div>

The total leaf number is multiplied by leaf cohort number and stem number (Figure \@ref(fig:leaf-number)).

<div class="fig-output">
```{r leaf-number, fig.asp = 1.3, fig.cap='Appeared number of green, senesced and total leaves'}
y_cols <- c(
    'Wheat.Leaf.PlantAppearedLeafNo',
    #'Wheat.Leaf.PlantAppearedGreenLeafNo',
    'Wheat.Leaf.PlantsenescedLeafNo')

plot_report(report, x_var, y_cols, x_lab = x_lab, 
            y_lab = 'Leaf number')
```
</div>



```{block, type='rmdimportant', echo=TRUE}
The tiller death is detached from plants, but leaf death isn't detached.
```


The fraction of final leaf is set as 1, but return the actual fraction of the final leaf if the last leaf has appeared. 

<div class="fig-output">
```{r final-leaf-fraction, fig.cap='Fraction of final leaf'}
# y_cols <- c(
#     'Wheat.Leaf.FinalLeafFraction')
# 
# plot_report(report, x_var, y_cols, x_lab = x_lab, 
#             y_lab = 'Fraction of final leaf')
```
</div>



## Development of leaf size

During the growth duration of each cohort, the daily increase of leaf area is detemined by the minimum increase of water ($\Delta A_{water}$) and carbon ($\Delta A_{carbon}$) constrained leaf area. 


### Maximum (potential) leaf area

The maximum leaf area of each leaf cohort is determined by potential maximum leaf area and reduced by cell division stress and final leaf fraction when leaf cohort is appeared. 


The potential maximum leaf areas by rank are specified by two parameters the maximum leaf area in all leaves (`AreaLargestLeaves` with default value 2600 mm^2^) and an age factor (Figure \@ref(fig:maximum-area-age)). The age factor is assumed leaf areas are linearly increasing from stage `Emergence` to `Terminal spikelet`, and all leaves appeared after stage `Terminal Spikelet` have the same maximum leaf area (the last three leaves in the current configuration of plastochron and phyllochron, Figure \@ref(fig:node-number)).

```{block, type='rmbimportant', echo=TRUE}
The function of maximum leaf size is proposed to change. Documentation needs to update.  
```


<div class="fig-input">
```{r maximum-area-age, fig.asp = 0.75, fig.cap='Multiplier of maximum leaf area as a function of growthing stage'}
# xpath <- '//Name[text()="AgeFactor"]'
# plot_xypair(pmf, xpath, x_lab = 'Growthing stage', y_lab = 'Multiplier of maximum leaf area')

```
</div>



The stress factor of cell division is determined by water (Figure \@ref(fig:water-supply-demand-ratio)) and nitrogen stresses (Figure \@ref(fig:nitrogen-functional-nitrogen)). Stress of cell division is averaged by cell division stress factors from initialization to appearance.

In the test simulation, the maximum leaf areas are increasing from Rank 1 to Rank 9, then decreasing to flag leaf (Figure \@ref(fig:leaf-cohort-max-area)), which is caused by nitrogen stress after terminal spikelet (Figure \@ref(fig:nitrogen-functional-nitrogen)). 

<div class="fig-output">
```{r leaf-cohort-max-area, fig.cap='Maximum area of leaf cohort as a function of stage or accumulated thermal time'}
# y_cols <- c(
#     'Wheat.Leaf.MaxLeafArea')
# plot_report_vector(
#     report, x_var, y_cols, x_lab = x_lab, 
#     y_lab = 'Maximum leaf area (mm2)')

```
</div>



### Potential expansion of leaf cohort

The potential leaf area is calculated by a logistic equation as a function of thermal time after leaf appearance. The shape of logistic equation is determiend by parameter `LeafSizeShapeParameter` with default value `0.3` (Fig. \@ref(fig:size-function)). 

```{r size-function, fig.asp=0.75, fig.cap='The size function of leaf area development'}

TT <- seq(0, 100, by = 1)
MaxArea <- 1000
LeafSizeShape <- 0.3
GrowthDuration <- 100
OneLessShape <- 1 - LeafSizeShape
alpha <- -log((1 / OneLessShape - 1) / (MaxArea / (MaxArea * LeafSizeShape) - 1)) / GrowthDuration
LeafSize <- MaxArea / (1 + (MaxArea / (MaxArea * LeafSizeShape) - 1) * exp(-alpha * TT))
y0 <- MaxArea / (1 + (MaxArea / (MaxArea * LeafSizeShape) - 1) * exp(-alpha * 0))
yDiffprop = y0 / (MaxArea/2)
ScaledLeafSize = (LeafSize - y0) / (1 - yDiffprop)
leaf_size <- data_frame(
    TT = TT
    , size = ScaledLeafSize
)

ggplot(leaf_size) + 
    geom_line(aes(TT, size)) +
    theme_bw() +
    xlab('Thermal time since appearance (oCd)') +
    ylab('Leaf area (mm2)')

```



### Water constrained leaf area

The potential increase of leaf area is reduced by `ExpansionStress` with default value 1



### Carbon constrained leaf area

<div class="fig-output">
```{r leaf-water-area, fig.cap='Delta of leaf area constrained by water and carbon.'}
# y_cols <- c(
#     'Wheat.Leaf.CohortDeltaWaterConstrainedArea',
#     'Wheat.Leaf.CohortDeltaCarbonConstrainedArea')
# plot_report_vector(
#     report, x_var, y_cols, x_lab = x_lab, 
#     y_lab = 'Delta of leaf area (mm2)')

```
</div>




<div class="fig-output">
```{r leaf-cohort-area, fig.cap='Leaf area by leaf cohort'}
# y_cols <- c(
#     'Wheat.Leaf.CohortArea')
# plot_report_vector(
#     report, x_var, y_cols, x_lab = x_lab, 
#     y_lab = 'Leaf area (mm2)')

```
</div>


Not sure about the meaning of leaf size?

<div class="fig-output">
```{r leaf-cohort-size, fig.cap='Leaf size by leaf cohort'}
# y_cols <- c(
#     'Wheat.Leaf.CohortSize')
# plot_report_vector(
#     report, x_var, y_cols, x_lab = x_lab, 
#     y_lab = 'Leaf size (mm3)')

```
</div>





Leaf area index (LAI) are calculated for green leaf ($\text{LAI}_{g}$), dead leaf ($\text{LAI}_{d}$), and total leaf ($\text{LAI}_{t}$). 


<div class="fig-output">
```{r leaf-lai, fig.cap='Leaf area index'}
y_cols <- c(
    'Wheat.Leaf.LAI', 
'Wheat.Leaf.LAIDead',
'Wheat.Leaf.LAITotal')
plot_report(report, x_var, y_cols, x_lab = x_lab, y_lab = 'Leaf area index')

```
</div>


### Leaf senescence

During the period of leaf senescene, the daily fraction of leaf senescence is linearly related with thermal time.


<div class="fig-output">
```{r leaf-fraction-senescence, fig.cap='Fraction of leaf senescence by leaf cohort in the remaining live leaf area.'}
# y_cols <- c(
#     'Wheat.Leaf.CohortSenescedFrac')
# plot_report_vector(
#     report, x_var, y_cols, x_lab = x_lab, 
#     y_lab = 'Fraction of leaf senescence in the remaining live leaf area')

```
</div>



## Ground coverage

and coverage are calculated for green leaf ($C_g$), dead leaf ($C_d$), and total leaf ($C_t$) from LAI and extinction coefficient for green leaf ($k_{g}$) and dead leaf ($k_{d}$). 

$$
C_{g}=C_{max}(1-\exp(-k_{g}\frac{\text{LAI}_{g}}{C_{max}}))
$$

As the default value of maximum coverage ($C_{max}$) is 1, the function is reduced to
$$
C_{g}=1-\exp(-k_{g}\text{LAI}_{g})
$$

The similar equation is used for dead coverage.

$$
C_{d}=1-\exp(-k_{d}\text{LAI}_{d})
$$

Total coverage ($C_t$) is calculated from coverage of green and dead leaves.
$$
    C_{t} = 1 - (1 - C_{g})(1 - C_{d})
$$

The extinction coefficient for dead leaf ($k_{d}$) is defined as 0.3. The extinction coefficient for green leaf ($k_{g}$) is calculated by parameter `ExtinctionCoeff` which is depending on LAI and water stress.  

In the current version of APSIM-Wheat, extinction coefficient is set as 0.5 without variation as leaf area index. 

```{block, type='rmdnote', echo=TRUE}
Extinction coefficient of dead leaf ($k_{d}$) is not setable in the APSIM User Interface which is defined in the xml file. 
```


<div class="fig-input">
```{r k-lai, fig.asp = 0.75, fig.cap='Extinction coefficient as a function of leaf area index (LAI)'}
# xpath <- '//Name[text()="PotentialExtinctionCoeff"]'
# plot_xypair(pmf, xpath, x_lab = 'Leaf area index', y_lab = 'Extinction coefficient')

```
</div>

The extinction coefficient of green leaf is adjusted by water stress which is the ratio of water supply and demand. No adjustment is applied to extinction coefficient if water supply is more than water demand. However, extinction coefficient is reduced when water supply is less than water demand (Figure \@ref(fig:k-water-stress), i.e. $k$ = 0.25 when no water supply).

<div class="fig-input">
```{r k-water-stress, fig.asp = 0.75, fig.cap='Multiplier of extinction coefficient as a function of water stress'}
# xpath <- '//MultiplyFunction[Name="ExtinctionCoeff"]/LinearInterpolationFunction/Name[text()="WaterStress"]'
# plot_xypair(pmf, xpath, x_lab = 'Ratio of water supply and demand', y_lab = 'Extinction coefficient')

```
</div>






<div class="fig-output">
```{r leaf-cover, fig.cap='Coverage'}
y_cols <- c(
    'Wheat.Leaf.CoverGreen',
    'Wheat.Leaf.CoverDead',
    'Wheat.Leaf.CoverTotal')
plot_report(report, x_var, y_cols, x_lab = x_lab, y_lab = 'Coverage')

```
</div>








<div class="fig-output">
```{r leaf-specific-leaf-area, fig.cap='Specific leaf area'}
y_cols <- c('Wheat.Leaf.SpecificArea')
plot_report(report, x_var, y_cols, x_lab = x_lab, y_lab = 'Specific leaf area (mm2/g)')

```
</div>


<div class="fig-output">
```{r leaf-cohortspecific-leaf-area, fig.cap='Specific leaf area by cohort'}
# y_cols <- c('Wheat.Leaf.CohortSLA')
# plot_report_vector(report, x_var, y_cols, x_lab = x_lab, y_lab = 'Specific leaf area (mm2/g)')

```
</div>

```{block, type='rmdwarning', echo=TRUE}
Why does specific leaf area of flag leaf decrease after a few days of appearance.
```


## Frost impact 

Kill a fraction in all leaves ...


## Biomass supply (Photosynthesis)

The daily biomass accumulation ($\Delta Q$) corresponds to dry-matter above-ground biomass, and is calculated as a potential biomass accumulation resulting from radiation interception ($\Delta Q_{r}$) that is limited by soil water deficiency ($\Delta Q_{w}$).

### Potential biomass accumulation from radiation use efficiency

The radiation-limited dry-biomass accumulation ($\Delta Q_{r}$) is calculated by the intercepted radiation ($I$), radiation use efficiency ($RUE$).

$$
\Delta Q_{r}=I \times RUE
$$

#### Radiation interception

Radiation interception is calculated from the leaf area index (LAI, m$^{2}$ m$^{-2}$) and the extinction coefficient (*k*) [@MonsiFactorLightPlant2005]. 
$$
I=I_{0}(1-\exp(-k\times LAI)
$$


where $I_{0}$ is the total radiation at the top of the canopy (MJ) which is directly imported from weather records. Extinction coefficient ($k$) set as a constant value 0.5 in current version of APSIM.

#### Actual radiation use efficiency

The actual $RUE$ (g MJ$^{\text{-1}}$) is calculated as the potential $RUE$ ($RUE_p$) and several reduction factors, including plant nutrition ($F_{n,\ photo}$), air temperature($F_{t,\ photo}$), vapour pressure deficit ($F_{vpd}$), water supply ($F_w$) and atmospheric CO2 concentration ($F_{co2}$).

\begin{equation}
RUE = RUE_p \times \min{(F_{t,\ photo}, F_{n,\ photo}, F_{VPD})} \times F_W \times F_{CO2}
\end{equation}

*The potential RUE ($RUE_p$)* has a default value 1.5 in the current version of APSIM.

*The temperature factor ($F_t$)* is calculated as a function of average daily temperature weighted toward maximum temperature according to the specified `MaximumTemperatureWeighting` factor ($W_{maxt}$) with default value 0.75 (reference).


$$F_{t,\ photo}=h_{t,\ photo}[W_{maxt}T_{max}+(1-W_{maxt})T_{min}]$$


<div class="fig-input">
```{r biomass-ft, fig.asp = 0.75, fig.cap='The temperature factor which influences radiation use efficiency'}
xpath <- '//Name[text()="FT"]'
plot_xypair(pmf, xpath, x_lab = 'Average daily temperature weighted toward maximum temperature', y_lab = 'Temperature factor to photosynthesis')

```
</div>


*The plant nutrition factor* $f_{n,\,photo}$ is determined by the difference between leaf nitrogen concentration and leaf minimum and critical nitrogen concentration.

$$
f_{N,\,photo}=R_{N,\,photo}\sum_{leaf}\frac{C_{N}-C_{N,\,min}}{C_{N,\,crit}-C_{N,\,min}}
$$


where $C_{N}$ is the nitrogen concentration of `Leaf` parts; $R_{N,\,expan}$ is multiplier for nitrogen deficit effect on phenology which is specified by `N_fact_photo` in the wheat.xml and default value is 1.5.


<div class="fig-input">
```{r biomass-fn, fig.asp = 0.75, fig.cap='The nitrogen factor which influences radiation use efficiency'}
xpath <- '//Name[text()="FN"]'
plot_xypair(pmf, xpath, x_lab = 'Average daily temperature weighted toward maximum temperature', y_lab = 'Temperature factor to photosynthesis')

```
</div>

**Water stress factor**


For C3 plants (like wheat),  **The CO$_{\text{2}}$ factor** is calculated by a function of environmental CO$_{\text{2}}$ concentration ($C$, ppm; $C$ > 350 ppm) and daily mean temperature ($T_{mean}$ < 50&deg;C) as published by @ReyengaModellingglobalchange1999

$$
f_{c}=\frac{(C-C_{i})(350+2C_{i})}{(C+2C_{i})(350-C_{i})}
$$

where $C_{i}$ is the temperature dependent CO$_{\text{2}}$ compensation point (ppm) and is derived from the following function. 
$$
C_{i}=\frac{163-T_{mean}}{5-0.1T_{mean}}
$$





-->





